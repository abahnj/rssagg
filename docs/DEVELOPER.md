# Developer Documentation

This document provides detailed technical information about the RSS Aggregator CLI (rssagg) for developers who want to understand or contribute to the codebase.

## Architecture Overview

The application follows a modular design with clear separation of concerns:

1. **CLI Layer**: Handles command parsing and user interaction
2. **Service Layer**: Implements business logic
3. **Data Layer**: Manages database operations

## Key Components

### Database

The application uses PostgreSQL with the following schema:

- **users**: Stores user information
  - `id`: UUID primary key
  - `created_at`: Timestamp
  - `updated_at`: Timestamp
  - `name`: User's display name

- **feeds**: Stores RSS feed information
  - `id`: UUID primary key
  - `created_at`: Timestamp
  - `updated_at`: Timestamp
  - `name`: Feed name
  - `url`: Feed URL (unique)
  - `user_id`: User who added the feed
  - `last_fetched_at`: Timestamp of last fetch

- **feed_follows**: Tracks which users follow which feeds
  - `id`: UUID primary key
  - `created_at`: Timestamp
  - `updated_at`: Timestamp
  - `user_id`: User following the feed
  - `feed_id`: Feed being followed
  - Unique constraint on (user_id, feed_id)

- **posts**: Stores content from feeds
  - `id`: UUID primary key
  - `created_at`: Timestamp
  - `updated_at`: Timestamp
  - `title`: Post title
  - `url`: Post URL (unique)
  - `description`: Post content
  - `published_at`: Publication timestamp
  - `feed_id`: Source feed

### SQL Queries

The application uses [sqlc](https://sqlc.dev/) to generate type-safe Go code from SQL queries. The queries are defined in `sql/queries/` directory.

### Go Packages

#### `internal/database`

Generated by sqlc, provides type-safe database operations.

#### `internal/config`

Handles configuration loading and validation.

```go
// Config represents application configuration
type Config struct {
    DatabaseURL string `json:"database_url"`
}

// LoadConfig loads application configuration from supported locations
func LoadConfig() (Config, error) {
    // Implementation loads from:
    // - ./config.json
    // - $HOME/.config/rssagg/config.json
}
```

#### `internal/users`

Manages user operations.

```go
// Service handles user operations
type Service struct {
    DB database.Queries
}

// Functions include:
// - CreateUser: Register a new user
// - GetUserByName: Retrieve user by name
// - ListUsers: Get all users
```

#### `internal/feeds`

Handles feed operations including fetching and parsing RSS content.

```go
// Service handles feed operations
type Service struct {
    DB database.Queries
}

// Functions include:
// - CreateFeed: Add a new feed
// - FetchFeed: Retrieve and parse an RSS feed from a URL
// - GetAllFeeds: List all feeds
// - FollowFeed: Create a feed follow relationship
// - UnfollowFeed: Remove a feed follow relationship
// - ScrapeFeed: Process and store feed content
```

#### `internal/posts`

Manages post operations.

```go
// Service handles post operations
type Service struct {
    DB database.Queries
}

// Functions include:
// - CreatePost: Add a new post from feed content
// - GetPostsForUser: Retrieve posts from followed feeds
```

## Data Flow

1. User initiates a command through the CLI
2. The command is parsed and routed to the appropriate handler
3. The handler calls the relevant service methods
4. Services communicate with the database through the generated sqlc code
5. Results are returned to the user

## RSS Feed Processing

1. The `agg` command starts a continuous process that:
   - Fetches the next feed due for updating
   - Retrieves the feed content as XML
   - Parses the XML into structured data
   - Processes each item in the feed
   - Stores new posts in the database
   - Updates the feed's last_fetched_at timestamp
   - Sleeps for the specified duration
   - Repeats

2. When processing a feed item:
   - The item is validated (must have title and URL)
   - Publication date is parsed (supporting multiple date formats)
   - A database record is created
   - Duplicates are detected via URL uniqueness constraint

## Error Handling

The application follows Go's standard error handling practices:
- Functions return errors when they fail
- Errors are wrapped with context using `fmt.Errorf` and `%w`
- Critical errors are reported to the user
- Some non-critical errors (like duplicate posts) are handled gracefully

## Testing

Unit tests are organized alongside the code they test. Integration tests that require a database connection are placed in separate packages to avoid import cycles.

## Command Middleware

Commands use a middleware pattern to handle cross-cutting concerns:
- Authentication: Ensures a user is logged in for commands that require it
- Error handling: Provides consistent error reporting to users

## Future Enhancements

Potential areas for improvement:
- Add support for ATOM feeds
- Implement feed categorization/tagging
- Add search functionality for posts
- Support for webhook notifications
- Web interface
- Export/import functionality